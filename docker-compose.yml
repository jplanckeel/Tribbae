version: "3.8"

services:
  # ── MongoDB ──────────────────────────────────────────────
  mongo:
    image: mongo:8
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: tribbae

  # ── Backend + Frontend (image unifiée) ───────────────────
  backend:
    image: jplanckeel/tribbae:latest
    restart: unless-stopped
    depends_on:
      - mongo
      - ollama
      - searxng
    ports:
      - "${PORT:-8080}:8080"
    environment:
      MONGO_URI: mongodb://mongo:27017
      MONGO_DB: tribbae
      JWT_SECRET: ${JWT_SECRET:?Set JWT_SECRET in .env}
      PORT: "8080"
      GRPC_PORT: "9090"
      BASE_URL: ${BASE_URL:-http://localhost:8080}
      OLLAMA_URL: http://ollama:11434
      OLLAMA_MODEL: ${OLLAMA_MODEL:-qwen2.5:1.5b}
      SEARXNG_URL: http://searxng:8080

  # ── Ollama (IA) ──────────────────────────────────────────
  ollama:
    image: ollama/ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    environment:
      OLLAMA_NUM_PARALLEL: "1"
      OLLAMA_MAX_LOADED_MODELS: "1"

  # ── SearXNG (recherche web) ──────────────────────────────
  searxng:
    build:
      context: ./searxng
    restart: unless-stopped
    volumes:
      - searxng_data:/etc/searxng
    environment:
      SEARXNG_BASE_URL: http://searxng:8080/

volumes:
  mongo_data:
  ollama_data:
  searxng_data:
